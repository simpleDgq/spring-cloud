# [尚硅谷2025最新SpringCloud速通-操作步骤（详细）_spirngcloud尚硅谷笔记2025-CSDN博客](https://blog.csdn.net/weixin_56884174/article/details/145573890)

https://github.com/mofan212/spring-cloud-demo

# 注册中心、配置中心-nacos

提供服务注册、服务发现的功能。

服务注册：注册微服务的信息

服务发现：发现微服务在哪

服务雪崩

服务熔断

![dd](./images/截屏2025-04-17%2016.20.53.png)

负载均衡：多个实例，请求发到哪个实例

动态刷新：nacos配置发生了变化，代码里面能动态读取到，不需要重启

**注册中心宕机了，远程调用还能成功吗？**

1.如果是第一次调用，会失败

2.如果不是第一次调用微服务，不会失败，因为有个缓存会存储注册中心里面相关的实例信息，先去缓存找。

**配置中心里面的配置和application.properties文件里面的配置冲突了，谁生效？**

配置中心里面的生效

**导入多个配置，相同的属性，前面的覆盖后面的**

spring.config.import=nacos:service-order.properties,common.properties

**配置中心-数据隔离**

多套环境，dev，test，prod，不同的配置，怎么隔离，怎么生效

namespace解决

一个namespace里面有多个分组，每个分组，就是一种微服务；一种微服务又可以有多个配置文件data-id

再通过springboot提供的多环境功能，每个环境绑定一个名称空间

使用namespace区分多种环境，使用分组区分多种微服务，使用数据集dataid区分多种配置

# OpenFeign

声明式 REST 客户端

进行远程调用，直接注解就可以

使用openfeign进行远程调用。openfeign自带负载均衡

**客户端负载均衡与服务端负载均衡的区别**

客户端负载均衡，在客户端实现，openfeign选择一个合适的服务实例进行调用

服务端负载均衡，第三方api服务内部自己实现，客户端不关心，第三方服务只是暴露一个接口给客户端用

**服务雪崩：**

比如订单服务调用商品服务的api，商品服务响应慢，会导致订单服务等待返回

如果还有其它服务调用订单服务，会导致整条链上都慢

高并发的情况下，等待的请求会很多，导致服务器资源耗尽

**超时控制**

openfeign自带连接超时、读取超时功能

连接超时：建立连接花的时间，默认10s

读取超时：被调用的服务处理请求的时间，默认60s

**重试机制**

feign自带重试机制，超时之后可以重试

**拦截器**

对feign的请求或者响应进行拦截，加工请求数据或者响应数据

RequestInterceptor + ResponseInterceptor

**feign调用一般要设置兜底回调，如果不设置，也最好搞一个全局的异常处理器进行处理**

# Sentinel

基本使用

## 在请求被block之后的，异常处理：

## 1.如果是web接口被Sentinel block

比如说/create这个接口。controller里面的接口，会默认被Sentinel管理，Sentinel控制台可以定义一些规则。

如果被block，会抛出异常，异常的处理底层是基于拦截器实现，SentinelWebInterceptor。可以自定义一个handler，返回想要的数据

## 2.如果是@SentinelResource标记的资源被Sentinel block

底层基于切面实现，SentinelResourceAspect。

如果定义了blockHandler，直接处理

如果定义了fallback，直接处理

如果定义了默认的fallback，直接处理

如果都没有，异常会被抛出，springboot自己的异常处理机制，最终默认返回一个错误页面，当然也可以自定义一个全局异常处理器，对异常进行处理

最佳实践：

@SentinelResource一般用在非controller层，哪些方法需要保护就加这个注解

如果业务上需要返回兜底数据，就可以用blockHandler或者fallback定义然后返回

如果没有，就使用项目的全局异常处理器，对异常进行处理

## 3.如果时候openfeign的调用，被Sentinel block

如果被调用的feign实现了fallback，则直接用

如果没有，则sprinboot全局异常进行处理

### 4.sphu硬编码的方式对异常进行处理

sphu硬编码，了解，用的不多

## 流控规则

流控阈值：qps和线程数

**流控模式：**

直接（默认）、链路、关联

直接：

当QPS超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出`FlowException`

链路：

多个路径，只针对设置的路径，进行限制

流控规则，链路模式  
多个链路，只针对其中的一条链路进行限制  
控制台配置哪个就限制哪个

关联：

系统资源出现竞争的时候使用

比如，读写数据库，当写请求多的时候，限制读请求，实现写优先的效果

设置的时候，是给readdb设置一个关联规则，管理的是writedb

当writedb流量大的时候，就会产生限制的效果

**流控效果：**

快速失败：没有超过阈值，则交给业务进行处理，多余的请求，直接抛出异常，多余的请求丢弃

**只有“快速失败”模式支持流控模式的设置（直接、关联、链路）**

warm up：有个时间窗口，请求数是从低到高放行，相当于有个预热过程，逐步到达设置的阈值

例子：

qps设置为10，时间窗口设置为3s

表示刚开始1s内，只能处理三分之一请求，后面每一秒增加请求数

好处：

不至于，系统还没预热好，请求过多，导致系统崩溃

匀速排队：

每秒固定可以放行的请求数量，其它的请求排队等待，超出timeout时间，直接丢弃

基于漏桶算法

## 熔断降级

解决服务雪崩。一般用于远程调用，在调用方进行配置

**断路器**

3种状态：打开，关闭，半打开

默认是关闭状态

**熔断策略：慢调用比例、异常比例、异常数**

当请求的比例达到上面对应阈值的时候，断路器会变为打开状态，

有个时间窗口，后面的请求会拒绝访问

时间窗口结束，断路器变为半开状态

然后会放行一个请求，请求失败，则断路器又会回到打开状态

请求成功，则断路器变为关闭状态，请求又可以访问了

有进行统计，达到阈值，周而复始

例子：

**慢调用比例：**

5s内，如果请求的最大响应时间超过1s，则是慢调用，

5s内慢调用的比例超过80%，则打开断路器，时间窗口是30s，这个30s内，所有的请求都会被拒绝

有个最小请求数，相当于有个最小样本，设置成5，表示至少5个请求

**有熔断和无熔断的区别？**

以前没有熔断的时候，openfeign如果设置了fallback，以及超时时间；如果请求超时或者被调用方发生了错误，都会调用fallback进行兜底处理

效率低，即使除了异常，还是会发请求给远程被调用方

**有了熔断后，会有个时间窗口不往远程发请求了**

**异常比例：**

5s内，如果请求异常数，超过了某个比例，比如80%，则有个时间窗口，比如30s，窗口内的请求都会被拒绝

**异常数：**

5s内，请求异常数，超过了某个阈值，比如10个，则有个时间窗口，比如30s，窗口内的请求都会被拒绝

## 热点规则（热点参数限流）

请求里面有参数，根据参数进行限流

一般是针对热点参数

不带这个参数的请求直接放行

带有这个参数的请求，如果超过了设置的阈值，就会被block

需求：

秒杀需求1：每个用户秒杀 QPS 不得超过 1（秒杀下单 userId 级别）

效果：携带此参数的参与流控，不携带不流控

需求2：6号用户是vvip，不限制QPS（例外情况） - Sentinel控制台，高级选项配置

需求3：666号是下架商品，不允许访问 - 高级选项，直接限流为0

fallback和blockHandler区别：  

* fallback指定的兜底回调，异常使用用Throwable，能处理所有的异常，比如业务执行期间抛出的异常  
* blockHandler，它只能处理BlockedException

# 网关

**路由规则**

1、配置文件里面写

2、代码

规则进行匹配的时候，是从上到下进行匹配，前面的路径匹配上之后，后面的就不会继续匹配

可以通过order定义优先级，值越大，优先级越低，就不会先匹配

**断言写法：**

官方文档：[Route Predicate Factories](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/request-predicates-factories.html)

两种方式
1.Shortcut Configuration

2.Fully Expanded Arguments

**自定义断言**

**过滤器：**

对请求和响应进行一些修改

官方文档：[GatewayFilter Factories](https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/gatewayfilter-factories.html)

**默认过滤器**

**自定义过滤器**

**全局过滤器**


